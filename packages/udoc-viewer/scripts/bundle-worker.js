/**
 * Post-build script: bundle the worker and generate inline code.
 *
 * 1. Bundles dist/src/worker/worker.js into a self-contained IIFE
 *    (inlines all JS deps, replaces import.meta.url at bundle time).
 * 2. Generates dist/src/worker/worker-inline.js with the worker source
 *    as a string constant for blob worker creation.
 * 3. Strips the dev-mode fallback (import.meta.url) from WorkerClient.js
 *    since WORKER_INLINE is always populated in dist.
 * 4. Replaces __VERSION__ placeholder in UDocClient.js with the actual
 *    version from package.json.
 */

import { build } from "esbuild";
import { readFileSync, writeFileSync } from "fs";
import { fileURLToPath } from "url";
import { dirname, join } from "path";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const distDir = join(__dirname, "../dist/src");
const distWorker = join(distDir, "worker/worker.js");

// --- Step 1: Bundle the worker into a self-contained IIFE ---
// Define import.meta.url as "about:blank" at bundle time to suppress the
// esbuild "empty-import-meta" warning and eliminate the dead-code fallback
// in wasm-bindgen glue that references import.meta.url.
await build({
  entryPoints: [distWorker],
  bundle: true,
  format: "iife",
  outfile: distWorker,
  allowOverwrite: true,
  define: { "import.meta.url": '"about:blank"' },
});

// --- Step 2: Read bundled worker for inline embedding ---
const workerCode = readFileSync(distWorker, "utf-8");

// --- Step 3: Generate worker-inline.js ---
// Embed the bundled worker as a string constant for blob worker creation.
const inlineJs = `// Auto-generated by scripts/bundle-worker.js \u2014 DO NOT EDIT\nexport const WORKER_INLINE = ${JSON.stringify(workerCode)};\n`;
writeFileSync(join(distDir, "worker/worker-inline.js"), inlineJs);

// --- Step 4: Strip dev-mode fallback from WorkerClient.js ---
// The source has a fallback using import.meta.url for Vite dev mode (when
// WORKER_INLINE is empty). In dist, WORKER_INLINE is always populated, so
// the fallback is dead code. Remove import.meta.url to avoid parse errors
// in environments like StackBlitz that don't support import.meta syntax.
const workerClientPath = join(distDir, "worker/WorkerClient.js");
let workerClientCode = readFileSync(workerClientPath, "utf-8");
workerClientCode = workerClientCode.replaceAll("import.meta.url", '"about:blank"');
writeFileSync(workerClientPath, workerClientCode);

// --- Step 5: Replace __VERSION__ in UDocClient.js ---
const pkg = JSON.parse(readFileSync(join(__dirname, "../package.json"), "utf-8"));
const clientPath = join(distDir, "UDocClient.js");
let clientCode = readFileSync(clientPath, "utf-8");
clientCode = clientCode.replaceAll('"__VERSION__"', JSON.stringify(pkg.version));
writeFileSync(clientPath, clientCode);

console.log(`Bundled worker (inline + standalone), version ${pkg.version}`);
